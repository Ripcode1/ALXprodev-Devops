#!/bin/bash

# Task 2: Batch Pokémon Data Retrieval
# Fetches data for multiple Pokemon with rate limiting and error handling

API_BASE="https://pokeapi.co/api/v2/pokemon"
OUTPUT_DIR="pokemon_data"
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
DELAY=1  # Delay in seconds between requests
MAX_RETRIES=3

# Create output directory if it doesn't exist
mkdir -p "$OUTPUT_DIR"

# Function to fetch Pokemon data with retry logic
fetch_pokemon() {
    local pokemon_name=$1
    local output_file="$OUTPUT_DIR/${pokemon_name}.json"
    local retries=0
    
    echo "Fetching data for $pokemon_name..."
    
    while [ $retries -lt $MAX_RETRIES ]; do
        # Make API request
        http_code=$(curl -s -w "%{http_code}" -o "$output_file" "${API_BASE}/${pokemon_name}")
        
        # Check if request was successful
        if [ "$http_code" = "200" ]; then
            echo "Saved data to $output_file ✅"
            return 0
        else
            retries=$((retries + 1))
            if [ $retries -lt $MAX_RETRIES ]; then
                echo "Failed (HTTP $http_code). Retrying... (Attempt $retries/$MAX_RETRIES)"
                sleep 2
            fi
        fi
    done
    
    # All retries failed
    echo "Error: Failed to fetch data for $pokemon_name after $MAX_RETRIES attempts. HTTP Status: $http_code" | tee -a errors.txt
    return 1
}

# Loop through Pokemon list
for pokemon in "${POKEMON_LIST[@]}"; do
    fetch_pokemon "$pokemon"
    # Add delay to avoid rate limiting (except for last item)
    if [ "$pokemon" != "${POKEMON_LIST[-1]}" ]; then
        sleep $DELAY
    fi
done
